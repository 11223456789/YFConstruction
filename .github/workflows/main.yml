# 工作流名称：萤丰智慧工地系统自动打包
name: YFConstruction Auto Build

# 触发条件：1.推代码到main分支自动触发 2.支持手动触发（新手推荐手动）
on:
  push:
    branches: [ main ]
  workflow_dispatch:  # 手动触发开关，重点！新手可先手动触发测试

# 定义任务集合
jobs:
  # ========== 任务1：编译Java后端（解决依赖+缓存污染问题） ==========
  build-backend:
    name: 编译Java后端代码
    runs-on: ubuntu-latest  # 使用Ubuntu系统运行
    steps:
      # 步骤1：拉取GitHub仓库的源码
      - name: 拉取项目源码
        uses: actions/checkout@v4

      # 步骤2：配置JDK 1.8（修复版本标识问题，直接写8）
      - name: 安装并配置JDK 8
        uses: actions/setup-java@v3
        with:
          java-version: '8'                # 核心修复：用8而非1.8
          distribution: 'temurin'          # 稳定的JDK发行版
          cache: maven                     # 缓存Maven依赖，加速后续打包

      # 步骤3：安装并配置Maven 3.5.4
      - name: 安装并配置Maven 3.5.4
        uses: stCarolas/setup-maven@v5
        with:
          maven-version: '3.5.4'           # 固定Maven版本，匹配项目要求

      # 步骤4：清理Maven污染缓存（解决POM文件报错核心步骤）
      - name: 清理被污染的Maven缓存
        run: |
          # 删除被非法内容污染的核心依赖缓存
          rm -rf ~/.m2/repository/org/springframework/boot/spring-boot-dependencies
          rm -rf ~/.m2/repository/org/springframework/cloud/spring-cloud-dependencies
          rm -rf ~/.m2/repository/com/alibaba/cloud/spring-cloud-alibaba-dependencies
          # 可选：清空整个Maven缓存（彻底解决依赖问题）
          # rm -rf ~/.m2/repository

      # 步骤5：编译后端代码（跳过测试加速打包）
      - name: 编译后端代码生成jar包
        run: |
          cd admin  # 进入后端根目录
          mvn clean package -DskipTests  # 编译打包，跳过测试用例

      # 步骤6：上传编译好的后端jar包（方便下载到VPS）
      - name: 上传后端jar包产物
        uses: actions/upload-artifact@v4
        with:
          name: backend-jars              # 产物名称，方便识别
          # 匹配所有模块的target目录下的jar包，排除原始包
          path: |
            admin/**/target/*.jar
            !admin/**/target/original-*.jar

  # ========== 任务2：编译Vue前端（依赖后端编译完成） ==========
  build-frontend:
    name: 编译Vue前端代码
    runs-on: ubuntu-latest
    needs: build-backend  # 必须等后端编译完成后再执行
    steps:
      # 步骤1：拉取源码（和后端共用源码）
      - name: 拉取项目源码
        uses: actions/checkout@v4

      # 步骤2：配置Node.js 14.18.0（匹配项目要求）
      - name: 安装并配置Node.js 14.18.0
        uses: actions/setup-node@v4
        with:
          node-version: '14.18.0'         # 固定Node版本
          cache: 'npm'                    # 缓存npm依赖，加速安装

      # 步骤3：升级npm到8.19.1
      - name: 升级npm到8.19.1版本
        run: npm install -g npm@8.19.1

      # 步骤4：安装前端依赖（用淘宝镜像加速）
      - name: 安装前端项目依赖
        run: |
          cd front  # 进入前端根目录
          npm config set registry https://registry.npmmirror.com  # 淘宝镜像
          npm install  # 安装package.json中的所有依赖

      # 步骤5：编译前端代码生成dist目录
      - name: 编译前端代码
        run: |
          cd front
          npm run build  # 执行打包命令

      # 步骤6：上传前端dist目录
      - name: 上传前端dist产物
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist             # 前端产物名称
          path: front/dist                # 前端编译产物路径
